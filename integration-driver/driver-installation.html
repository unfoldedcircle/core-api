<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Install integration driver on the device - Unfolded Circle API Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Unfolded Circle API Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="driver-installation-on-the-remote"><a class="header" href="#driver-installation-on-the-remote">Driver installation on the Remote</a></h1>
<p>Starting with firmware v1.9.0, custom installation drivers can be installed on the Remote.</p>
<p>‼️ Custom integration drivers is a developer preview and not all features are implemented yet. See <a href="#missing-features">missing features</a>.</p>
<h2 id="installation-archive-format"><a class="header" href="#installation-archive-format">Installation archive format</a></h2>
<p>Integration driver archive requirements:</p>
<ul>
<li>TAR GZip archive (either .tgz or .tar.gz file suffix) with a maximum size of 100 MB.</li>
<li>In the root of the archive, there must be a <code>driver.json</code> metadata file describing the custom integration driver.</li>
<li>The driver binary must be in the <code>./bin</code> subdirectory.
<ul>
<li>Either a statically linked aarch64 executable named <code>driver</code>.</li>
<li>Or a Node.js file named <code>driver.js</code>.</li>
</ul>
</li>
<li>All application files must be in one of the following subdirectories, other locations are not accessible at runtime:
<ul>
<li><code>./bin</code>: application binary folder.</li>
<li><code>./config</code>: optional configuration data. Path is accessible with <code>UC_CONFIG_HOME</code> environment variable.</li>
<li><code>./data</code>: optional application data. Path is accessible with <code>UC_DATA_HOME</code> environment variable.</li>
</ul>
</li>
</ul>
<h3 id="metadata-file"><a class="header" href="#metadata-file">Metadata file</a></h3>
<p>The <code>driver.json</code> metadata file in the root of the archive describes the integration driver.</p>
<p>‼️ The data schema is not yet included in the Core-API, the full object is shown below.
It is a reduced version of the <code>IntegrationDriver</code> object, without driver connection fields like driver_url, token etc.</p>
<pre><code class="language-json">{
  "driver_id": "foobar",
  "version": "1.0.0",
  "min_core_api": "0.20.0",
  "name": {
    "en": "Foobar special"
  },
  "icon": "custom:foobar.png",
  "description": {
    "en": "Control Foobar products",
    "de": "Steuere Foobar Produkte"
  },
  "features": [
    {
      "name": "auth.external_tokens",
      "required": true
    }
  ],
  "developer": {
    "name": "Unfolded Circle ApS",
    "email": "hello@unfoldedcircle.com",
    "url": "https://www.unfoldedcircle.com"
  },
  "home_page": "https://www.unfoldedcircle.com",
  "setup_data_schema": {
    "title": {
      "en": "Integration setup",
      "de": "Integrationssetup"
    },
    "settings": [
      {
        "id": "info",
        "label": {
          "en": "Setup process",
          "de": "Setup Fortschritt"
        },
        "field": {
          "label": {
            "value": {
              "en": "The integration will discover your Foobar products on your network. This process is automatic and can take a few minutes.",
              "de": "Diese Integration wird Foobar Produkte im Netzwerk finden. Dies ist ein Automatischer Prozess der ein paar Minuten dauern kann."
            }
          }
        }
      }
    ]
  },
  "release_date": "2024-07-21"
}
</code></pre>
<ul>
<li><code>driver_id</code> must be at least 5 characters long and start with a lower-case letter.
<ul>
<li>Only lower-case letters, digits and <code>-</code>, <code>_</code> are allowed.</li>
<li>Common system identifiers are not allowed and will be rejected (e.g. <code>daemon</code>, <code>backup</code>, etc.).</li>
<li>The <code>uc_</code> prefix should not be used. This is reserved for pre-installed integrations. Any custom integrations using
this prefix might get removed during a future firmware update.</li>
</ul>
</li>
<li>Multiple language fields are not required, but recommended.
<ul>
<li>If only a single language is provided, it should use the <code>en</code> key.</li>
</ul>
</li>
<li><code>setup_data_schema</code> is optional if the driver provides a setup flow.
<ul>
<li>This is the first screen of the setup, all further screens are dynamically provided by the driver.</li>
</ul>
</li>
<li>⚠️ <code>min_core_api</code> is not yet used.</li>
</ul>
<h3 id="driver-icon"><a class="header" href="#driver-icon">Driver icon</a></h3>
<p>A driver icon can either use a predefined icon or a custom icon. Predefined icons are prefixed with <code>uc:</code>, followed by
the icon identifier in lowercase.</p>
<p>A custom driver icon can be installed automatically as custom icon resource.</p>
<ol>
<li>In <code>driver.json</code> set the icon field to <code>custom:$ICON_FILENAME</code></li>
<li>Include <code>$ICON_FILENAME</code> in the root of the archive.</li>
</ol>
<p>Example <code>driver.json</code> (other fields omitted for simplicity):</p>
<pre><code class="language-json">{
  "icon": "custom:foobar.png"
}
</code></pre>
<p>The icon file called <code>foobar.png</code> must be added to the root of the archive.
Icons must be of size 90x90 pixels and either in PNG or JPG format. Maximum size is 32 KB.</p>
<h3 id="installation-archive-example"><a class="header" href="#installation-archive-example">Installation archive example</a></h3>
<p>Example of a Node.js based integration driver archive (contents of bin/node_modules are not shown for a clearer overview):</p>
<pre><code>.
├── bin
│   ├── driver.js
│   ├── node_modules
│   │   ├── ...
│   │   ├── foobar
│   │   ├── uc-integration-api
│   │   ├── ws
│   │   └── ...
│   └── foobar.js
├── config
├── data
├── driver.json
└── foobar.png
</code></pre>
<ul>
<li>If the driver doesn't require any data or configuration files, the <code>./data</code> and <code>./config</code> directories can be omitted
from the archive.
<ul>
<li>During the installation, the data and config directories are automatically created and can be accessed by the driver
at runtime, no matter if they were provided in the installation archive or not.</li>
</ul>
</li>
<li>The <code>driver.json</code> file in the root folder is automatically copied to the <code>./bin</code> folder during installation if it is
missing.
<ul>
<li>If the driver requires a different <code>driver.json</code> file, simply include a file in the <code>./bin</code> folder.<br />
The one in the root folder won't be copied anymore.</li>
</ul>
</li>
</ul>
<h2 id="restrictions"><a class="header" href="#restrictions">Restrictions</a></h2>
<ul>
<li>Maximum 10 custom integrations can be installed.</li>
<li>Only Node.js is supported besides a statically linked binary. Other runtimes are not supported at the moment.
<ul>
<li>Python integrations must pack the Python runtime into the archive.</li>
</ul>
</li>
<li>The integration driver runs in a sandbox. Access to devices and the filesystem is restricted.</li>
<li>No symlinks are allowed. They are automatically removed during the installation.</li>
<li>Executable files are only allowed in the <code>./bin</code> directory.
<ul>
<li>No other tools are provided in the runtime environment. E.g. there is no shell available and no other tools
like <code>cp</code> or <code>mv</code>.</li>
</ul>
</li>
</ul>
<h3 id="missing-features"><a class="header" href="#missing-features">Missing features</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
Resource restrictions for integration drivers: limit maximum amount of memory and CPU usage.</li>
<li><input disabled="" type="checkbox"/>
Update an installed integrations.
<ul>
<li>Workaround: remove and re-install.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
Resource usage: provide memory and CPU usage per integration.
<ul>
<li>Only the overall resource usage can be monitored with <code>GET /api/pub/status</code>.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
Web-Configurator support: install custom integration drivers.
<ul>
<li>Custom integration drivers can already be deleted in the web-configurator.</li>
</ul>
</li>
</ul>
<h3 id="runtime-environment"><a class="header" href="#runtime-environment">Runtime environment</a></h3>
<p>The driver runs in a sandbox with limited access to the host system.</p>
<ul>
<li>Environment variables for the Websocket integration-API server:
<ul>
<li><code>UC_INTEGRATION_INTERFACE</code>: network interface to bind to.</li>
<li><code>UC_INTEGRATION_HTTP_PORT</code>: port number.</li>
</ul>
</li>
<li>The working directory is set to the binary directory.</li>
<li>The binary directory is read-only.</li>
<li>Node.js version: v20.16 (firmware release 1.9.3 and newer).
<ul>
<li>There are no pre-installed node modules.</li>
<li>An integration driver must include all required modules in the installation archive, including <code>uc-integration-api</code> (if used).</li>
</ul>
</li>
<li>File access with relative paths between <code>bin</code>, <code>config</code>, and <code>data</code> is not possible.
<ul>
<li>Environment variables must be used to retrieve the full path of these directories.
<ul>
<li><code>UC_CONFIG_HOME</code> and <code>HOME</code>: configuration directory.</li>
<li><code>UC_DATA_HOME</code>: data directory.</li>
</ul>
</li>
<li>The returned path may not be stored, it may change with future software updates.</li>
</ul>
</li>
<li>Only the <code>$UC_CONFIG_HOME</code> and <code>$UC_DATA_HOME</code> directories are writeable and persisted between restarts.
<ul>
<li>The <code>/tmp</code> directory can be used for small temporary files.
<ul>
<li>This is a RAM file system and limited by the available free memory.</li>
<li>Temporary files are not persisted between restarts.</li>
</ul>
</li>
</ul>
</li>
<li>A dynamic user and group is allocated when the driver is started.
<ul>
<li>The user and group IDs may change between driver restarts.</li>
<li>Write access to the <code>$UC_CONFIG_HOME</code>, <code>$UC_DATA_HOME</code> and <code>/tmp</code> directories is ensured.</li>
</ul>
</li>
</ul>
<p>⚠️ CPU and memory restrictions are not yet in place but will be enforced in a future firmware update!</p>
<ul>
<li>A single integration driver should not use more than 100 MB of memory.</li>
</ul>
<p><em>TODO more details about sandbox environment</em></p>
<h4 id="network"><a class="header" href="#network">Network</a></h4>
<p>The integration runs on the same network environment as the Remote. There is no network bridge or firewall.</p>
<ul>
<li>Binding ports below 1024 is not possible.</li>
</ul>
<p>⚠️ A port-binding filter might be added in the future to prevent integrations to steal away ports of other integrations.
The port range 8000-9200 and port 13333 are not allowed to be used!</p>
<h4 id="native-integration-drivers"><a class="header" href="#native-integration-drivers">Native integration drivers</a></h4>
<p><em>TODO sysroot, available dynamic libraries</em></p>
<p>The <a href="https://github.com/unfoldedcircle/ucr2-toolchain">Remote Two Cross Compile Toolchain</a> can be used to cross-compile
a native binary for the Remote.</p>
<ul>
<li>The driver must be compiled as a static binary for libc.</li>
<li>Most dynamic libraries in the cross-compile sysroot are NOT available in the custom integration runtime environment!</li>
</ul>
<h2 id="install-driver"><a class="header" href="#install-driver">Install driver</a></h2>
<pre><code class="language-shell">curl --location 'http://$IP/api/intg/install' \
--user 'web-configurator:$PIN' \
--form 'file=@"custom-intg.tar.gz"'
</code></pre>
<p>See <a href="../../core-api/rest/README.html">REST Core API</a> for more details.</p>
<h2 id="delete-driver"><a class="header" href="#delete-driver">Delete driver</a></h2>
<p>To delete a custom integration, use the regular endpoints to delete an integration instance and driver.
These are the same endpoints as for an external network integration driver:</p>
<ul>
<li>Delete integration instance <code>DELETE /api/intg/instances/:intgId</code>.</li>
<li>Delete driver and installation files: <code>DELETE /api/intg/drivers/:driverId</code>.</li>
</ul>
<p>See <a href="../../core-api/rest/README.html">REST Core API</a> for more details.</p>
<p>The instance and driver can also be deleted in the web-configurator.</p>
<h2 id="log-access"><a class="header" href="#log-access">Log access</a></h2>
<p>Output to stdout and stderr are automatically stored with a timestamp and accessible as the other system logs:</p>
<ul>
<li>Get log services: <code>GET /api/system/logs/services</code>.</li>
<li>Query logs: <code>GET /api/system/logs?...</code>.</li>
</ul>
<p>See <a href="../../core-api/rest/README.html">REST Core API</a> for more details.</p>
<p>Log files can also be downloaded in the web-configurator: <em>Settings, Development: Logs</em></p>
<h3 id="web-app-log-viewer"><a class="header" href="#web-app-log-viewer">Web-app log viewer</a></h3>
<p>⚠️ Available from firmware release v2.1.0</p>
<p>The <a href="https://logdy.dev/">Logdy</a> web application is installed on the device to monitor integration driver log events in
near real time.</p>
<ul>
<li>URL: <code>http://$IP/log/</code></li>
<li>This function is deactivated by default and the endpoint returns 503.</li>
<li>The log viewer must be started using the <a href="../../core-api/rest/README.html">REST Core API</a>
with the <code>/api/system/logs/web</code> endpoint:
<ul>
<li><code>GET</code> request returns the current state.</li>
<li><code>PUT</code> request allows to start, stop or to permanently enable the log app. A password can be set to restrict access
to the web app.</li>
</ul>
</li>
<li>Available logs:
<ul>
<li>Remote core service</li>
<li>All pre-installed and custom integrations</li>
<li>Custom remote-ui service if installed</li>
</ul>
</li>
<li>❗️The log processing and logdy daemon require around 170 MB of the custom integration memory pool.</li>
</ul>
<p>Using curl to start the app:</p>
<pre><code class="language-shell">curl --request PUT 'http://$IP/api/system/logs/web' \
  --header 'Content-Type: application/json' \
  --user web-configurator:$PIN \
  --data '{"enabled": true}'
</code></pre>
<p>Start and permanently enable the app, even after a reboot:</p>
<pre><code class="language-shell">curl --request PUT 'http://$IP/api/system/logs/web' \
  --header 'Content-Type: application/json' \
  --user web-configurator:$PIN \
  --data '{"enabled": true; "autostart": true}'
</code></pre>
<h2 id="recommendations"><a class="header" href="#recommendations">Recommendations</a></h2>
<ul>
<li>Node.js should be preferred for writing integration drivers.</li>
<li>If using Python:
<ul>
<li>Use <a href="https://pyinstaller.org/">PyInstaller</a> to create a binary distribution.</li>
<li>Use the default one-folder bundle containing an executable (<code>--onedir</code>). Avoid the one-file bundled executable, since
it will easily use an additional 100 MB of memory!</li>
<li>See <a href="https://github.com/unfoldedcircle/integration-androidtv">Android TV integration</a> or <a href="https://github.com/unfoldedcircle/integration-appletv">Apple TV integration</a>
as an example.</li>
</ul>
</li>
<li>An integration driver should be limited to one process and not launch other processes.</li>
<li>Use ports above 10000 if the integration needs to create an IPv4 or IPv6 server socket (besides the required WebSocket
server for the integration-API).</li>
<li>Preserve resources, use as little memory and CPU as possible.</li>
<li>Use stdout &amp; stderr for logging.</li>
<li>Only use <code>/tmp</code> for small, temporary files since it is a RAM file system.</li>
</ul>
<h2 id="example-integrations"><a class="header" href="#example-integrations">Example integrations</a></h2>
<p>The following Python based integration drivers create a custom integration installation archive during build with a
GitHub action:</p>
<ul>
<li><a href="https://github.com/unfoldedcircle/integration-androidtv">Android TV</a></li>
<li><a href="https://github.com/unfoldedcircle/integration-appletv">Apple TV</a></li>
<li><a href="https://github.com/unfoldedcircle/integration-denonavr">Denon AVR</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../integration-driver/driver-setup.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../integration-driver/driver-setup.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
